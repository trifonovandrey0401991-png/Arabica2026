# Финальное решение проблемы FIS_AUTH_ERROR

## Проблема
Ошибка `FIS_AUTH_ERROR` не решается, несмотря на:
- ✅ SHA-1 и SHA-256 сертификаты добавлены
- ✅ Эмулятор с Google Play Services
- ✅ google-services.json на месте
- ✅ Package name совпадает

## КОРНЕВАЯ ПРИЧИНА

Скорее всего, проблема в **настройках API-ключа в Google Cloud Console**. Firebase Installations API может быть не включен или ограничен.

## РЕШЕНИЕ 1: Проверить и включить Firebase Installations API

### Шаг 1: Откройте Google Cloud Console
1. Перейдите: https://console.cloud.google.com/
2. Выберите проект: **arabica2027-6d78d**

### Шаг 2: Проверьте API-ключи
1. Перейдите: **APIs & Services** → **Credentials**
2. Найдите API-ключ: `AIzaSyBhZg2UmjUyZ4APQGDOEuxYjkdO_vgkMAo` (из google-services.json)
3. Нажмите на ключ для редактирования

### Шаг 3: Проверьте ограничения API
1. В разделе **API restrictions** проверьте:
   - Если выбрано **"Restrict key"**, убедитесь, что **Firebase Installations API** включен
   - Если **Firebase Installations API** отсутствует, добавьте его:
     - Нажмите **"Restrict key"**
     - Выберите **"Restrict key to APIs"**
     - В списке найдите и включите:
       - ✅ **Firebase Installations API**
       - ✅ **Firebase Cloud Messaging API**
       - ✅ **Firebase Remote Config API** (если используется)
     - Сохраните изменения

### Шаг 4: Проверьте, что API включен
1. Перейдите: **APIs & Services** → **Library**
2. Найдите **Firebase Installations API**
3. Убедитесь, что API **включен** (Enabled)
4. Если не включен, нажмите **Enable**

### Шаг 5: Подождите 5-10 минут
Изменения в Google Cloud Console могут применяться с задержкой.

### Шаг 6: Переустановите приложение
```powershell
cd C:\Users\Admin\arabica2026
flutter clean
flutter pub get
flutter run
```

---

## РЕШЕНИЕ 2: Временно отключить проверку токена (если Решение 1 не помогло)

Если проблема не решается, можно временно отключить получение токена, чтобы приложение работало. Push-уведомления не будут работать, но остальной функционал будет работать нормально.

### Изменения в коде:
В `lib/firebase_service.dart` метод `_getTokenWithRetries` можно изменить, чтобы он сразу возвращал `null` без попыток получения токена:

```dart
static Future<String?> _getTokenWithRetries(FirebaseMessaging messaging) async {
  print('⚠️ ВРЕМЕННО: Получение токена отключено из-за FIS_AUTH_ERROR');
  print('⚠️ Приложение работает, но push-уведомления не будут работать');
  return null;
}
```

**НЕ РЕКОМЕНДУЕТСЯ для production**, но можно использовать для тестирования остального функционала.

---

## РЕШЕНИЕ 3: Проверить настройки Firebase проекта

### Шаг 1: Проверьте настройки проекта
1. Откройте: https://console.firebase.google.com/
2. Проект: **arabica2027-6d78d**
3. Перейдите: **⚙️ Настройки проекта** → **Общие**

### Шаг 2: Проверьте Cloud Messaging
1. Перейдите: **⚙️ Настройки проекта** → **Облачные сообщения**
2. Убедитесь, что **Cloud Messaging API (V1)** включен
3. Если есть ключ сервера, убедитесь, что он активен

### Шаг 3: Пересоздайте Android приложение (если ничего не помогает)
1. Удалите существующее Android приложение из Firebase Console
2. Добавьте Android приложение заново:
   - Package name: `com.example.arabica_app`
3. Скачайте новый `google-services.json`
4. Замените файл в `android/app/google-services.json`
5. Добавьте SHA-сертификаты снова
6. Подождите 15-30 минут
7. Переустановите приложение

---

## РЕШЕНИЕ 4: Использовать другой эмулятор

Проблема может быть в конкретном эмуляторе:
1. Создайте новый эмулятор в Android Studio
2. Убедитесь, что используется **Google Play** (не Google APIs)
3. Запустите приложение на новом эмуляторе

---

## РЕШЕНИЕ 5: Проверить интернет-соединение эмулятора

1. На эмуляторе откройте браузер
2. Попробуйте открыть любой сайт
3. Если интернет не работает, перезапустите эмулятор

---

## РЕКОМЕНДАЦИЯ

**Начните с Решения 1** - это самая частая причина проблемы `FIS_AUTH_ERROR`. Если это не поможет, попробуйте Решение 3 (пересоздать Android приложение).

Если ничего не помогает, можно временно использовать Решение 2, чтобы приложение работало без push-уведомлений, пока проблема не будет решена.

