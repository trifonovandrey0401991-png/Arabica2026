# –ê–Ω–∞–ª–∏–∑ –º–æ–¥—É–ª–µ–π "–ì–ª–∞–≤–Ω–∞—è –ö–∞—Å—Å–∞" –∏ "–ö–æ–Ω–≤–µ—Ä—Ç"

**–î–∞—Ç–∞:** 2026-01-26
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ú–æ–¥—É–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞—é—Ç, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–º–æ–¥—É–ª–µ–π)
2. [–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏](#–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ-–º–µ–∂–¥—É-–º–æ–¥—É–ª—è–º–∏)
3. [–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö](#–º–æ–¥–µ–ª–∏-–¥–∞–Ω–Ω—ã—Ö)
4. [API Endpoints](#api-endpoints)
5. [–°–µ—Ä–≤–∏—Å—ã](#—Å–µ—Ä–≤–∏—Å—ã)
6. [–ü–æ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è](#–ø–æ—Ç–æ–∫-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
7. [–ö–ª—é—á–µ–≤—ã–µ —Å–≤—è–∑–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏](#–∫–ª—é—á–µ–≤—ã–µ-—Å–≤—è–∑–∏-–∏-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
8. [–¢–æ—á–∫–∏ —Ä–æ—Å—Ç–∞](#—Ç–æ—á–∫–∏-—Ä–æ—Å—Ç–∞)
9. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏)
10. [–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞](#–∏—Ç–æ–≥–æ–≤–∞—è-–æ—Ü–µ–Ω–∫–∞)

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π

### 1.1 –ú–æ–¥—É–ª—å "–ì–ª–∞–≤–Ω–∞—è –ö–∞—Å—Å–∞" (main_cash)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º –∫–∞—Å—Å—ã –≤—Å–µ–π —Å–µ—Ç–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∫–∞–∂–¥–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ (–û–û–û –∏ –ò–ü –æ—Ç–¥–µ–ª—å–Ω–æ) –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Ö–æ–¥–æ–≤ –∏–∑ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏–∑ –≤—ã–µ–º–æ–∫.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:**
```
lib/features/main_cash/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ shop_cash_balance_model.dart      # –ë–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã –º–∞–≥–∞–∑–∏–Ω–∞ (–û–û–û + –ò–ü)
‚îÇ   ‚îú‚îÄ‚îÄ withdrawal_model.dart             # –ú–æ–¥–µ–ª—å –≤—ã–µ–º–∫–∏ –¥–µ–Ω–µ–≥
‚îÇ   ‚îî‚îÄ‚îÄ withdrawal_expense_model.dart     # –ú–æ–¥–µ–ª—å —Ä–∞—Å—Ö–æ–¥–∞ –≤ —Ä–∞–º–∫–∞—Ö –≤—ã–µ–º–∫–∏
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ main_cash_service.dart            # –°–µ—Ä–≤–∏—Å –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ –º–∞–≥–∞–∑–∏–Ω–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ withdrawal_service.dart           # CRUD –≤—ã–µ–º–æ–∫ + —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ turnover_service.dart             # –°–µ—Ä–≤–∏—Å –¥–∞–Ω–Ω—ã—Ö –æ–± –æ–±–æ—Ä–æ—Ç–µ
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ main_cash_page.dart               # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (2 –≤–∫–ª–∞–¥–∫–∏)
‚îÇ   ‚îú‚îÄ‚îÄ shop_balance_details_page.dart    # –î–µ—Ç–∞–ª–∏ –±–∞–ª–∞–Ω—Å–∞ –º–∞–≥–∞–∑–∏–Ω–∞ + –∫–∞–ª–µ–Ω–¥–∞—Ä—å –æ–±–æ—Ä–æ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ withdrawal_shop_selection_page.dart       # –í—ã–±–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ –¥–ª—è –≤—ã–µ–º–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ withdrawal_employee_selection_page.dart   # –í—ã–±–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ withdrawal_form_page.dart         # –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤
‚îî‚îÄ‚îÄ widgets/
    ‚îú‚îÄ‚îÄ turnover_calendar.dart            # –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å –æ–±–æ—Ä–æ—Ç–æ–º
    ‚îú‚îÄ‚îÄ withdrawal_dialog.dart            # –î–∏–∞–ª–æ–≥–∏ –¥–ª—è –≤—ã–µ–º–∫–∏
    ‚îî‚îÄ‚îÄ withdrawal_confirmation_dialog.dart  # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–µ–º–∫–∏
```

**–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å:**
- `loyalty-proxy/api/withdrawals_api.js` - Endpoints –¥–ª—è –≤—ã–µ–º–æ–∫
- –•—Ä–∞–Ω–∏–ª–∏—â–µ: `/var/www/withdrawals/` (JSON —Ñ–∞–π–ª—ã)
- –•—Ä–∞–Ω–∏–ª–∏—â–µ: `/var/www/main_cash/` (–∫–µ—à –±–∞–ª–∞–Ω—Å–æ–≤)

---

### 1.2 –ú–æ–¥—É–ª—å "–ö–æ–Ω–≤–µ—Ä—Ç" (envelope)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é –∫–æ–Ω–≤–µ—Ä—Ç–∞ —Å –Ω–∞–ª–∏—á–Ω—ã–º–∏ –≤ –∫–æ–Ω—Ü–µ —Å–º–µ–Ω—ã. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–µ—Ç Z-–æ—Ç—á–µ—Ç—ã, –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –û–û–û –∏ –ò–ü (–≤—ã—Ä—É—á–∫–∞, –Ω–∞–ª–∏—á–Ω—ã–µ, —Ä–∞—Å—Ö–æ–¥—ã), –∏ —Å–æ–∑–¥–∞–µ—Ç –æ—Ç—á–µ—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–æ–º.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:**
```
lib/features/envelope/
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ envelope_report_model.dart        # –û—Ç—á—ë—Ç –æ –∫–æ–Ω–≤–µ—Ä—Ç–µ (–û–û–û + –ò–ü –¥–∞–Ω–Ω—ã–µ)
‚îÇ   ‚îî‚îÄ‚îÄ envelope_question_model.dart      # –í–æ–ø—Ä–æ—Å/—à–∞–≥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ envelope_report_service.dart      # CRUD –æ—Ç—á—ë—Ç–æ–≤ –∫–æ–Ω–≤–µ—Ä—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ envelope_question_service.dart    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ envelope_form_page.dart           # –ú–Ω–æ–≥–æ—à–∞–≥–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (9 —à–∞–≥–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ envelope_reports_list_page.dart   # –°–ø–∏—Å–æ–∫ –æ—Ç—á—ë—Ç–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ envelope_report_view_page.dart    # –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á—ë—Ç–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–º
‚îÇ   ‚îî‚îÄ‚îÄ envelope_questions_management_page.dart  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞–º–∏ (–∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å)
‚îî‚îÄ‚îÄ widgets/
    ‚îî‚îÄ‚îÄ add_expense_dialog.dart           # –î–∏–∞–ª–æ–≥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤
```

**–°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å:**
- `loyalty-proxy/index.js` (lines 4862-5284) - Endpoints –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤
- –•—Ä–∞–Ω–∏–ª–∏—â–µ: `/var/www/envelope-reports/` (JSON —Ñ–∞–π–ª—ã)
- –•—Ä–∞–Ω–∏–ª–∏—â–µ: `/var/www/envelope-questions/` (JSON —Ñ–∞–π–ª—ã)

---

## 2. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

### 2.1 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ–ª—å –ö–æ–Ω–≤–µ—Ä—Ç–∞ –¥–ª—è –ì–ª–∞–≤–Ω–æ–π –ö–∞—Å—Å—ã

**üîë –ö–õ–Æ–ß–ï–í–ê–Ø –ö–û–ù–¶–ï–ü–¶–ò–Ø:**

**–ö–æ–Ω–≤–µ—Ä—Ç —è–≤–ª—è–µ—Ç—Å—è –ò–°–¢–û–ß–ù–ò–ö–û–ú –î–û–•–û–î–ê –¥–ª—è –ì–ª–∞–≤–Ω–æ–π –ö–∞—Å—Å—ã:**

```
–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç:
  ‚îú‚îÄ oooCash: 15000 —Ä—É–± (–Ω–∞–ª–∏—á–Ω—ã–µ –û–û–û –≤ –∫–æ–Ω–≤–µ—Ä—Ç–µ)
  ‚îî‚îÄ ipCash: 8000 —Ä—É–± (–Ω–∞–ª–∏—á–Ω—ã–µ –ò–ü –≤ –∫–æ–Ω–≤–µ—Ä—Ç–µ)
         ‚Üì
EnvelopeReport —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
         ‚Üì
MainCashService —á–∏—Ç–∞–µ—Ç —ç—Ç–∏ –æ—Ç—á—ë—Ç—ã
         ‚Üì
–≠—Ç–∏ —Å—É–º–º—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –î–û–•–û–î–û–ú –≤ –±–∞–ª–∞–Ω—Å–µ –≥–ª–∞–≤–Ω–æ–π –∫–∞—Å—Å—ã
```

**–í—ã–µ–º–∫–∏ - —ç—Ç–æ –†–ê–°–•–û–î–´:**

```
–ê–¥–º–∏–Ω —Å–æ–∑–¥–∞—ë—Ç –≤—ã–µ–º–∫—É (Withdrawal):
  ‚îú‚îÄ –ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º: 50000 —Ä—É–±
  ‚îú‚îÄ –ó–∞–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: 20000 —Ä—É–±
  ‚îî‚îÄ –î—Ä—É–≥–∏–µ —Ä–∞—Å—Ö–æ–¥—ã: 5000 —Ä—É–±
         ‚Üì
–≠—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã
```

**–§–æ—Ä–º—É–ª–∞ –±–∞–ª–∞–Ω—Å–∞:**

```
–ë–∞–ª–∞–Ω—Å –º–∞–≥–∞–∑–∏–Ω–∞ = –î–æ—Ö–æ–¥ (–∏–∑ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤) - –†–∞—Å—Ö–æ–¥ (–∏–∑ –≤—ã–µ–º–æ–∫)

oooBalance = sum(envelope.oooCash) - sum(withdrawal.totalAmount –≥–¥–µ type='ooo')
ipBalance = sum(envelope.ipCash) - sum(withdrawal.totalAmount –≥–¥–µ type='ip')
totalBalance = oooBalance + ipBalance
```

---

### 2.2 –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –¥–∞–Ω–Ω—ã—Ö

```mermaid
flowchart TB
    START[–ù–∞—á–∞–ª–æ —Å–º–µ–Ω—ã] --> WORK[–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç]
    WORK --> END_SHIFT[–ö–æ–Ω–µ—Ü —Å–º–µ–Ω—ã]

    END_SHIFT --> ENVELOPE[–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞]
    ENVELOPE --> PHOTO_Z[–§–æ—Ç–æ Z-–æ—Ç—á–µ—Ç–æ–≤ –û–û–û + –ò–ü]
    PHOTO_Z --> INPUT_DATA[–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö:<br/>oooCash, ipCash<br/>–≤—ã—Ä—É—á–∫–∞, —Ä–∞—Å—Ö–æ–¥—ã]
    INPUT_DATA --> PHOTO_ENV[–§–æ—Ç–æ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤]
    PHOTO_ENV --> SUBMIT[–û—Ç–ø—Ä–∞–≤–∫–∞ EnvelopeReport]

    SUBMIT --> SAVE_DB[(–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤<br/>/var/www/envelope-reports/)]

    SAVE_DB --> MAIN_CASH[–ì–ª–∞–≤–Ω–∞—è –ö–∞—Å—Å–∞]
    MAIN_CASH --> LOAD_DATA[–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö:<br/>EnvelopeReports + Withdrawals]
    LOAD_DATA --> CALC[–†–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞:<br/>–î–æ—Ö–æ–¥ - –†–∞—Å—Ö–æ–¥]
    CALC --> SHOW[–ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å –∞–¥–º–∏–Ω—É]

    SHOW --> WITHDRAW_Q{–ù—É–∂–Ω–∞ –≤—ã–µ–º–∫–∞?}
    WITHDRAW_Q -->|–î–∞| CREATE_WITHDRAW[–°–æ–∑–¥–∞—Ç—å Withdrawal]
    CREATE_WITHDRAW --> EXPENSES[–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã:<br/>–∑–∞—Ä–ø–ª–∞—Ç–∞, –∑–∞–∫—É–ø–∫–∏ –∏ —Ç.–¥.]
    EXPENSES --> SAVE_WITHDRAW[(–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤<br/>/var/www/withdrawals/)]
    SAVE_WITHDRAW --> RECALC[–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å]
    RECALC --> SHOW

    WITHDRAW_Q -->|–ù–µ—Ç| DONE[–ö–æ–Ω–µ—Ü]

    style ENVELOPE fill:#4CAF50,color:#fff
    style MAIN_CASH fill:#2196F3,color:#fff
    style CREATE_WITHDRAW fill:#FF9800,color:#fff
```

---

### 2.3 –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –≤ MainCashService

```
MainCashPage
    ‚Üì
MainCashService.getShopBalances()
    ‚Üì
    ‚îú‚îÄ‚Üí ShopService.getShops()                    (1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤)
    ‚îú‚îÄ‚Üí EnvelopeReportService.getReports()        (2. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Ç—á—ë—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤)
    ‚îî‚îÄ‚Üí WithdrawalService.getWithdrawals()        (3. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤—ã–µ–º–∫–∏)
    ‚Üì
–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º:
    ‚îú‚îÄ –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞:
    ‚îÇ   ‚îú‚îÄ –°—É–º–º–∏—Ä–æ–≤–∞—Ç—å oooCash –∏–∑ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤ ‚Üí oooIncome
    ‚îÇ   ‚îú‚îÄ –°—É–º–º–∏—Ä–æ–≤–∞—Ç—å ipCash –∏–∑ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤ ‚Üí ipIncome
    ‚îÇ   ‚îú‚îÄ –°—É–º–º–∏—Ä–æ–≤–∞—Ç—å totalAmount –∏–∑ –≤—ã–µ–º–æ–∫ –û–û–û ‚Üí oooWithdrawals
    ‚îÇ   ‚îú‚îÄ –°—É–º–º–∏—Ä–æ–≤–∞—Ç—å totalAmount –∏–∑ –≤—ã–µ–º–æ–∫ –ò–ü ‚Üí ipWithdrawals
    ‚îÇ   ‚îú‚îÄ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å: oooBalance = oooIncome - oooWithdrawals
    ‚îÇ   ‚îî‚îÄ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å: ipBalance = ipIncome - ipWithdrawals
    ‚Üì
–í–æ–∑–≤—Ä–∞—Ç: List<ShopCashBalance>
```

---

## 3. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### 3.1 ShopCashBalance (–ë–∞–ª–∞–Ω—Å –º–∞–≥–∞–∑–∏–Ω–∞)

```dart
class ShopCashBalance {
  final String shopAddress;           // –ê–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞
  final double oooBalance;            // –ë–∞–ª–∞–Ω—Å –û–û–û
  final double ipBalance;             // –ë–∞–ª–∞–Ω—Å –ò–ü
  final double oooTotalIncome;        // –í—Å–µ–≥–æ –¥–æ—Ö–æ–¥–∞ –û–û–û (–∏–∑ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤)
  final double ipTotalIncome;         // –í—Å–µ–≥–æ –¥–æ—Ö–æ–¥–∞ –ò–ü (–∏–∑ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤)
  final double oooTotalWithdrawals;   // –í—Å–µ–≥–æ –≤—ã–µ–º–æ–∫ –û–û–û
  final double ipTotalWithdrawals;    // –í—Å–µ–≥–æ –≤—ã–µ–º–æ–∫ –ò–ü

  // –†–∞—Å—á–µ—Ç–Ω–æ–µ –ø–æ–ª–µ
  double get totalBalance => oooBalance + ipBalance;

  // –ú–µ—Ç–æ–¥—ã
  factory ShopCashBalance.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}
```

**–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:**
```json
{
  "shopAddress": "—É–ª. –õ–µ–Ω–∏–Ω–∞, 1",
  "oooBalance": 45000.0,
  "ipBalance": 23000.0,
  "oooTotalIncome": 150000.0,
  "ipTotalIncome": 80000.0,
  "oooTotalWithdrawals": 105000.0,
  "ipTotalWithdrawals": 57000.0
}
```

---

### 3.2 Withdrawal (–í—ã–µ–º–∫–∞ –¥–µ–Ω–µ–≥)

```dart
class Withdrawal {
  final String id;
  final String shopAddress;
  final String employeeName;
  final String employeeId;
  final String type;                  // 'ooo' –∏–ª–∏ 'ip'
  final double totalAmount;           // –°—É–º–º–∞ –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
  final List<WithdrawalExpense> expenses;  // –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
  final String? adminName;
  final DateTime createdAt;
  final bool confirmed;               // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –ª–∏ –≤—ã–µ–º–∫–∞

  factory Withdrawal.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}

class WithdrawalExpense {
  final String? supplierId;           // ID –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (–∏–ª–∏ null –¥–ª—è "–î—Ä—É–≥–æ–π —Ä–∞—Å—Ö–æ–¥")
  final String? supplierName;         // –ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
  final double amount;                // –°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞
  final String comment;               // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π

  bool get isOtherExpense => supplierId == null;

  factory WithdrawalExpense.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}
```

**–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:**
```json
{
  "id": "withdrawal_1769420000000_abc123",
  "shopAddress": "—É–ª. –õ–µ–Ω–∏–Ω–∞, 1",
  "employeeName": "–ú–∞—Ä–∏—è",
  "employeeId": "79054443224",
  "type": "ooo",
  "totalAmount": 75000.0,
  "expenses": [
    {
      "supplierId": "emp_79051112233",
      "supplierName": "–ó–∞—Ä–ø–ª–∞—Ç–∞: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
      "amount": 50000.0,
      "comment": "–ó–∞—Ä–ø–ª–∞—Ç–∞ –∑–∞ —è–Ω–≤–∞—Ä—å"
    },
    {
      "supplierId": "supplier_001",
      "supplierName": "–û–û–û –ü–æ—Å—Ç–∞–≤—â–∏–∫",
      "amount": 20000.0,
      "comment": "–ó–∞–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"
    },
    {
      "supplierId": null,
      "supplierName": null,
      "amount": 5000.0,
      "comment": "–î—Ä—É–≥–∏–µ —Ä–∞—Å—Ö–æ–¥—ã"
    }
  ],
  "adminName": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
  "createdAt": "2026-01-26T14:00:00.000Z",
  "confirmed": false
}
```

---

### 3.3 EnvelopeReport (–û—Ç—á—ë—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞)

```dart
class EnvelopeReport {
  final String id;
  final String employeeName;
  final String shopAddress;
  final String shiftType;             // 'morning' –∏–ª–∏ 'evening'
  final DateTime createdAt;

  // –û–û–û –¥–∞–Ω–Ω—ã–µ
  final String? oooZReportPhotoUrl;
  final double oooRevenue;            // –í—ã—Ä—É—á–∫–∞ –∏–∑ Z-–æ—Ç—á–µ—Ç–∞
  final double oooCash;               // –ù–∞–ª–∏—á–Ω—ã–µ –≤ –∫–æ–Ω–≤–µ—Ä—Ç–µ (–î–û–•–û–î –¥–ª—è –∫–∞—Å—Å—ã)
  final List<ExpenseItem> oooExpenses;
  final String? oooEnvelopePhotoUrl;

  // –ò–ü –¥–∞–Ω–Ω—ã–µ
  final String? ipZReportPhotoUrl;
  final double ipRevenue;
  final double ipCash;                // –ù–∞–ª–∏—á–Ω—ã–µ –≤ –∫–æ–Ω–≤–µ—Ä—Ç–µ (–î–û–•–û–î –¥–ª—è –∫–∞—Å—Å—ã)
  final List<ExpenseItem> expenses;   // –†–∞—Å—Ö–æ–¥—ã (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—É–º–º –≤ –∫–æ–Ω–≤–µ—Ä—Ç–µ)
  final String? ipEnvelopePhotoUrl;

  // –°—Ç–∞—Ç—É—Å
  final String status;                // 'pending' –∏–ª–∏ 'confirmed'
  final DateTime? confirmedAt;
  final String? confirmedByAdmin;
  final int? rating;                  // 1-5 –∑–≤–µ–∑–¥

  // –†–∞—Å—á–µ—Ç—ã
  double get totalEnvelopeAmount => oooEnvelopeAmount + ipEnvelopeAmount;
  double get oooEnvelopeAmount => oooCash - oooTotalExpenses;
  double get ipEnvelopeAmount => ipCash - totalExpenses;

  factory EnvelopeReport.fromJson(Map<String, dynamic> json);
  Map<String, dynamic> toJson();
}
```

**–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:**
```json
{
  "id": "envelope_1769420000000_xyz789",
  "employeeName": "–ê–ª–µ–∫—Å–µ–π",
  "shopAddress": "—É–ª. –õ–µ–Ω–∏–Ω–∞, 1",
  "shiftType": "evening",
  "createdAt": "2026-01-26T20:00:00.000Z",
  "oooZReportPhotoUrl": "https://arabica26.ru/envelope-photos/ooo_z_123.jpg",
  "oooRevenue": 18000.0,
  "oooCash": 15000.0,
  "oooExpenses": [],
  "oooEnvelopePhotoUrl": "https://arabica26.ru/envelope-photos/ooo_env_123.jpg",
  "ipZReportPhotoUrl": "https://arabica26.ru/envelope-photos/ip_z_123.jpg",
  "ipRevenue": 12000.0,
  "ipCash": 8000.0,
  "expenses": [
    {
      "name": "–ú–æ–ª–æ–∫–æ",
      "amount": 500.0
    }
  ],
  "ipEnvelopePhotoUrl": "https://arabica26.ru/envelope-photos/ip_env_123.jpg",
  "status": "pending",
  "confirmedAt": null,
  "confirmedByAdmin": null,
  "rating": null
}
```

---

## 4. API Endpoints

### 4.1 Withdrawals API

**–°–µ—Ä–≤–µ—Ä:** `loyalty-proxy/api/withdrawals_api.js`
**–•—Ä–∞–Ω–∏–ª–∏—â–µ:** `/var/www/withdrawals/`

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã |
|-------|----------|----------|-----------|
| GET | `/api/withdrawals` | –ü–æ–ª—É—á–∏—Ç—å –≤—ã–µ–º–∫–∏ | `shopAddress`, `type`, `fromDate`, `toDate` |
| POST | `/api/withdrawals` | –°–æ–∑–¥–∞—Ç—å –≤—ã–µ–º–∫—É | Body: `{shopAddress, employeeName, type, expenses, ...}` |
| PATCH | `/api/withdrawals/:id/confirm` | –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–µ–º–∫—É | - |
| DELETE | `/api/withdrawals/:id` | –£–¥–∞–ª–∏—Ç—å –≤—ã–µ–º–∫—É | - |

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ POST /api/withdrawals:**
1. –°–æ–∑–¥–∞–µ—Ç JSON —Ñ–∞–π–ª –≤ `/var/www/withdrawals/`
2. –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã –≤ `/var/www/main_cash/`
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º

---

### 4.2 Envelope Reports API

**–°–µ—Ä–≤–µ—Ä:** `loyalty-proxy/index.js` (lines 5043-5284)
**–•—Ä–∞–Ω–∏–ª–∏—â–µ:** `/var/www/envelope-reports/`

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã |
|-------|----------|----------|-----------|
| GET | `/api/envelope-reports` | –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç—ã | `shopAddress`, `status`, `fromDate`, `toDate` |
| POST | `/api/envelope-reports` | –°–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç | Body: `{employeeName, shopAddress, shiftType, oooCash, ipCash, ...}` |
| PUT | `/api/envelope-reports/:id` | –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç | Body: –≤–µ—Å—å –æ–±—ä–µ–∫—Ç –æ—Ç—á—ë—Ç–∞ |
| PUT | `/api/envelope-reports/:id/confirm` | –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç—á—ë—Ç | Body: `{confirmedByAdmin, rating}` |
| DELETE | `/api/envelope-reports/:id` | –£–¥–∞–ª–∏—Ç—å –æ—Ç—á—ë—Ç | - |
| GET | `/api/envelope-reports/expired` | –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ | - (—Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è) |

---

### 4.3 Envelope Questions API

**–°–µ—Ä–≤–µ—Ä:** `loyalty-proxy/index.js` (lines 4862-5040)
**–•—Ä–∞–Ω–∏–ª–∏—â–µ:** `/var/www/envelope-questions/`

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/api/envelope-questions` | –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ order) |
| POST | `/api/envelope-questions` | –°–æ–∑–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å |
| PUT | `/api/envelope-questions/:id` | –û–±–Ω–æ–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å |
| DELETE | `/api/envelope-questions/:id` | –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å |

---

## 5. –°–µ—Ä–≤–∏—Å—ã

### 5.1 MainCashService

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**

```dart
// –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
static Future<List<ShopCashBalance>> getShopBalances()

// –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
static Future<ShopCashBalance?> getShopBalance(String shopAddress)

// –ü–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ (–∏–∑ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤)
static Future<List<String>> getShopAddressesWithData()
```

**–õ–æ–≥–∏–∫–∞ getShopBalances():**

```dart
// 1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã
final shops = await Shop.loadShopsFromServer();

// 2. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Ç—á—ë—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤
final envelopeReports = await EnvelopeReportService.getReports();

// 3. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≤—ã–µ–º–∫–∏
final withdrawals = await WithdrawalService.getWithdrawals();

// 4. –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º
for (final shop in shops) {
  double oooIncome = 0;
  double ipIncome = 0;
  double oooWithdrawals = 0;
  double ipWithdrawals = 0;

  // –°—É–º–º–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Ö–æ–¥—ã –∏–∑ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤
  for (final report in envelopeReports) {
    if (report.shopAddress == shop.address) {
      oooIncome += report.oooCash;
      ipIncome += report.ipCash;
    }
  }

  // –°—É–º–º–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –∏–∑ –≤—ã–µ–º–æ–∫
  for (final withdrawal in withdrawals) {
    if (withdrawal.shopAddress == shop.address) {
      if (withdrawal.type == 'ooo') {
        oooWithdrawals += withdrawal.totalAmount;
      } else if (withdrawal.type == 'ip') {
        ipWithdrawals += withdrawal.totalAmount;
      }
    }
  }

  // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å—ã
  final oooBalance = oooIncome - oooWithdrawals;
  final ipBalance = ipIncome - ipWithdrawals;

  balances.add(ShopCashBalance(
    shopAddress: shop.address,
    oooBalance: oooBalance,
    ipBalance: ipBalance,
    oooTotalIncome: oooIncome,
    ipTotalIncome: ipIncome,
    oooTotalWithdrawals: oooWithdrawals,
    ipTotalWithdrawals: ipWithdrawals,
  ));
}

return balances;
```

---

### 5.2 WithdrawalService

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**

```dart
// –ü–æ–ª—É—á–∏—Ç—å –≤—ã–µ–º–∫–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
static Future<List<Withdrawal>> getWithdrawals({
  String? shopAddress,
  String? type,
  DateTime? fromDate,
  DateTime? toDate,
})

// –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤—ã–µ–º–∫—É
static Future<Withdrawal?> createWithdrawal(Withdrawal withdrawal)

// –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–µ–º–∫—É
static Future<bool> confirmWithdrawal(String id)

// –ü–æ–ª—É—á–∏—Ç—å —Å—É–º–º—É –≤—ã–µ–º–æ–∫ –û–û–û –∏ –ò–ü –ø–æ –º–∞–≥–∞–∑–∏–Ω—É
static Future<Map<String, double>> getWithdrawalTotals(String shopAddress)
```

---

### 5.3 EnvelopeReportService

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**

```dart
// –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
static Future<List<EnvelopeReport>> getReports({
  String? shopAddress,
  String? status,
  DateTime? fromDate,
  DateTime? toDate,
})

// –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ç—á—ë—Ç
static Future<EnvelopeReport?> createReport(EnvelopeReport report)

// –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç—á—ë—Ç —Å –æ—Ü–µ–Ω–∫–æ–π
static Future<EnvelopeReport?> confirmReport(
  String id,
  String adminName,
  int rating,
)

// –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã (>24 —á–∞—Å–æ–≤ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
static Future<List<EnvelopeReport>> getExpiredReports()
```

---

## 6. –ü–æ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 6.1 –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞ (—Å–æ—Ç—Ä—É–¥–Ω–∏–∫)

```
1. –û—Ç–∫—Ä—ã—Ç—å "–ö–æ–Ω–≤–µ—Ä—Ç" ‚Üí EnvelopeFormPage
2. –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è EnvelopeQuestions (9 —à–∞–≥–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
3. –ú–Ω–æ–≥–æ—à–∞–≥–æ–≤–∞—è —Ñ–æ—Ä–º–∞:

   –®–∞–≥ 1: –í—ã–±—Ä–∞—Ç—å —Å–º–µ–Ω—É
     ‚îú‚îÄ –£—Ç—Ä–æ (morning)
     ‚îî‚îÄ –í–µ—á–µ—Ä (evening)

   –®–∞–≥–∏ 2-4: –û–û–û
     ‚îú‚îÄ –®–∞–≥ 2: –§–æ—Ç–æ Z-–æ—Ç—á–µ—Ç–∞ –û–û–û
     ‚îú‚îÄ –®–∞–≥ 3: –î–∞–Ω–Ω—ã–µ –û–û–û (–≤—ã—Ä—É—á–∫–∞, –Ω–∞–ª–∏—á–Ω—ã–µ –≤ –∫–æ–Ω–≤–µ—Ä—Ç–µ)
     ‚îî‚îÄ –®–∞–≥ 4: –§–æ—Ç–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞ –û–û–û

   –®–∞–≥–∏ 5-8: –ò–ü
     ‚îú‚îÄ –®–∞–≥ 5: –§–æ—Ç–æ Z-–æ—Ç—á–µ—Ç–∞ –ò–ü
     ‚îú‚îÄ –®–∞–≥ 6: –î–∞–Ω–Ω—ã–µ –ò–ü (–≤—ã—Ä—É—á–∫–∞, –Ω–∞–ª–∏—á–Ω—ã–µ –≤ –∫–æ–Ω–≤–µ—Ä—Ç–µ)
     ‚îú‚îÄ –®–∞–≥ 7: –†–∞—Å—Ö–æ–¥—ã –ò–ü (–º–æ–ª–æ–∫–æ, —Ö–ª–µ–± –∏ —Ç.–¥.)
     ‚îî‚îÄ –®–∞–≥ 8: –§–æ—Ç–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞ –ò–ü

   –®–∞–≥ 9: –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
     ‚îî‚îÄ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–≤–æ–¥–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö

4. –ù–∞–∂–∞—Ç—å "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç"
5. POST /api/envelope-reports
6. EnvelopeReport —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å status='pending'
7. –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤–∏–¥–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
```

---

### 6.2 –ü—Ä–æ—Å–º–æ—Ç—Ä –≥–ª–∞–≤–Ω–æ–π –∫–∞—Å—Å—ã (–∞–¥–º–∏–Ω)

```
1. –û—Ç–∫—Ä—ã—Ç—å "–ì–ª–∞–≤–Ω–∞—è –ö–∞—Å—Å–∞" ‚Üí MainCashPage
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è MainCashService.getShopBalances()
   ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã
   ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –æ—Ç—á—ë—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤
   ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –≤—ã–µ–º–∫–∏
   ‚îî‚îÄ –í—ã—á–∏—Å–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã

3. –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –¥–≤–µ –≤–∫–ª–∞–¥–∫–∏:

   üìä –í–∫–ª–∞–¥–∫–∞ 1: "–ö–∞—Å—Å–∞"
     ‚îú‚îÄ –¢–∞–±–ª–∏—Ü–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –º–∞–≥–∞–∑–∏–Ω–æ–≤
     ‚îú‚îÄ –ö–æ–ª–æ–Ω–∫–∏: –ú–∞–≥–∞–∑–∏–Ω | –û–û–û | –ò–ü | –ò—Ç–æ–≥–æ
     ‚îî‚îÄ –ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å –Ω–∞ –º–∞–≥–∞–∑–∏–Ω ‚Üí ShopBalanceDetailsPage

   üì• –í–∫–ª–∞–¥–∫–∞ 2: "–í—ã–µ–º–∫–∏"
     ‚îú‚îÄ –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤—ã–µ–º–æ–∫
     ‚îú‚îÄ –§–∏–ª—å—Ç—Ä—ã: –í—Å–µ / –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ
     ‚îî‚îÄ –ú–æ–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–µ–º–∫—É

4. –î–µ–π—Å—Ç–≤–∏—è:
   ‚îú‚îÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –º–∞–≥–∞–∑–∏–Ω–∞ (–±–∞–ª–∞–Ω—Å + –∫–∞–ª–µ–Ω–¥–∞—Ä—å –æ–±–æ—Ä–æ—Ç–∞)
   ‚îú‚îÄ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤—ã–µ–º–∫—É (–∫–Ω–æ–ø–∫–∞ "–°–¥–µ–ª–∞—Ç—å –≤—ã–µ–º–∫—É")
   ‚îî‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–µ–º–∫—É
```

---

### 6.3 –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–µ–º–∫–∏ (–∞–¥–º–∏–Ω)

```
1. MainCashPage ‚Üí –Ω–∞–∂–∞—Ç—å "–°–¥–µ–ª–∞—Ç—å –≤—ã–µ–º–∫—É"
2. WithdrawalShopSelectionPage
   ‚îî‚îÄ –í—ã–±—Ä–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω –∏–∑ —Å–ø–∏—Å–∫–∞

3. WithdrawalEmployeeSelectionPage
   ‚îî‚îÄ –í—ã–±—Ä–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–∫–æ–º—É –≤—ã–¥–∞—Ç—å –¥–µ–Ω—å–≥–∏)

4. WithdrawalFormPage
   ‚îú‚îÄ –í—ã–±—Ä–∞—Ç—å —Ç–∏–ø: –û–û–û –∏–ª–∏ –ò–ü
   ‚îú‚îÄ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã:
   ‚îÇ   ‚îú‚îÄ –í—ã–±—Ä–∞—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (–∏–ª–∏ "–î—Ä—É–≥–æ–π —Ä–∞—Å—Ö–æ–¥")
   ‚îÇ   ‚îú‚îÄ –í–≤–µ—Å—Ç–∏ —Å—É–º–º—É
   ‚îÇ   ‚îî‚îÄ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
   ‚îî‚îÄ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞

5. –ù–∞–∂–∞—Ç—å "–°–æ–∑–¥–∞—Ç—å –≤—ã–µ–º–∫—É"
6. POST /api/withdrawals
7. –°–µ—Ä–≤–µ—Ä:
   ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç Withdrawal –≤ /var/www/withdrawals/
   ‚îú‚îÄ –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –≤ /var/www/main_cash/
   ‚îî‚îÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º

8. –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—ã–µ–º–∫—É –≤ —Å–ø–∏—Å–∫–µ —Å confirmed=false
9. –î—Ä—É–≥–æ–π –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–µ–º–∫—É
```

---

### 6.4 –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞ (–∞–¥–º–∏–Ω)

```
1. –û—Ç–∫—Ä—ã—Ç—å "–ö–æ–Ω–≤–µ—Ä—Ç—ã" ‚Üí EnvelopeReportsListPage
2. –°–ø–∏—Å–æ–∫ –æ—Ç—á—ë—Ç–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏:
   ‚îú‚îÄ –û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   ‚îú‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ
   ‚îî‚îÄ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ

3. –í—ã–±—Ä–∞—Ç—å –æ—Ç—á—ë—Ç ‚Üí EnvelopeReportViewPage
4. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å:
   ‚îú‚îÄ –§–æ—Ç–æ Z-–æ—Ç—á–µ—Ç–æ–≤ (–û–û–û –∏ –ò–ü)
   ‚îú‚îÄ –§–æ—Ç–æ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤ (–û–û–û –∏ –ò–ü)
   ‚îú‚îÄ –î–∞–Ω–Ω—ã–µ: –≤—ã—Ä—É—á–∫–∞, –Ω–∞–ª–∏—á–Ω—ã–µ, —Ä–∞—Å—Ö–æ–¥—ã
   ‚îî‚îÄ –†–∞—Å—á–µ—Ç—ã: —Å—É–º–º–∞ –≤ –∫–æ–Ω–≤–µ—Ä—Ç–µ

5. –í—ã–±—Ä–∞—Ç—å –æ—Ü–µ–Ω–∫—É (1-5 –∑–≤–µ–∑–¥)
6. –ù–∞–∂–∞—Ç—å "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"
7. PUT /api/envelope-reports/:id/confirm
8. –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ 'confirmed'
9. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è: confirmedByAdmin, rating, confirmedAt
```

---

## 7. –ö–ª—é—á–µ–≤—ã–µ —Å–≤—è–∑–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### 7.1 –ì–ª–∞–≤–Ω–∞—è –ö–∞—Å—Å–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:

| –ú–æ–¥—É–ª—å | –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ö–æ–≥–¥–∞ |
|--------|------------------|-------|
| **Envelope** | –ß–∏—Ç–∞–µ—Ç EnvelopeReports –¥–ª—è –¥–æ—Ö–æ–¥–∞ (oooCash + ipCash) | –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–∞–ª–∞–Ω—Å–æ–≤ |
| **Withdrawals** | –ß–∏—Ç–∞–µ—Ç Withdrawals –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ (totalAmount) | –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–∞–ª–∞–Ω—Å–æ–≤ |
| **Shops** | –°–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ | –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ |
| **Employees** | –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏ –≤—ã–µ–º–∫–µ | –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã–µ–º–∫–∏ |
| **Suppliers** | –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ | –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã–µ–º–∫–∏ |

---

### 7.2 –ö–æ–Ω–≤–µ—Ä—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:

| –ú–æ–¥—É–ª—å | –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ö–æ–≥–¥–∞ |
|--------|------------------|-------|
| **EnvelopeQuestions** | –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ñ–æ—Ä–º—ã (9 —à–∞–≥–æ–≤) | –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã |
| **Suppliers** | –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –ò–ü | –ü—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞ |
| **AI Training** | Z-report recognition (OCR) | –ü—Ä–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞–Ω–∏–∏ Z-–æ—Ç—á–µ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| **Shops** | –ê–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ | –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞ |

---

### 7.3 –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ENVELOPE        ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ  MAIN_CASH       ‚îÇ
‚îÇ (–î–æ—Ö–æ–¥)         ‚îÇ  oooCash‚îÇ  (–ë–∞–ª–∞–Ω—Å)        ‚îÇ
‚îÇ                 ‚îÇ  ipCash ‚îÇ                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                      ‚Üë
                                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ
‚îÇ WITHDRAWALS     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ (–†–∞—Å—Ö–æ–¥)        ‚îÇ  totalAmount
‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 8. –¢–æ—á–∫–∏ —Ä–æ—Å—Ç–∞

### 8.1 üü¢ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 1. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `MainCashService`, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ —Å–ª–æ–∂–Ω—ã–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ:**
–í—ã–Ω–µ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π `BalanceCalculationService`:
```dart
class BalanceCalculationService {
  static ShopCashBalance calculateBalance({
    required String shopAddress,
    required List<EnvelopeReport> envelopeReports,
    required List<Withdrawal> withdrawals,
  }) {
    // –ß–∏—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±–µ–∑ side-effects
    // –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è
  }
}
```

**–ü–æ–ª—å–∑–∞:**
- –£–ø—Ä–æ—â–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏
- –£–ª—É—á—à–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞

---

#### 2. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:**
`MainCashService.getShopBalances()` –¥–µ–ª–∞–µ—Ç 3 –∑–∞–ø—Ä–æ—Å–∞ –∫–∞–∂–¥—ã–π —Ä–∞–∑:
1. –ü–æ–ª—É—á–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω—ã
2. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç—ã
3. –ü–æ–ª—É—á–∏—Ç—å –≤—ã–µ–º–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ —Å invalidation:
```dart
class CachedMainCashService {
  static final _cache = CacheManager<List<ShopCashBalance>>();
  static const _cacheDuration = Duration(minutes: 5);

  static Future<List<ShopCashBalance>> getShopBalances({
    bool forceRefresh = false,
  }) async {
    if (!forceRefresh && _cache.isValid()) {
      return _cache.get();
    }

    final balances = await MainCashService.getShopBalances();
    _cache.set(balances, _cacheDuration);
    return balances;
  }

  static void invalidateCache() {
    _cache.clear();
  }
}
```

**–í—ã–∑—ã–≤–∞—Ç—å invalidation –ø—Ä–∏:**
- –°–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞
- –°–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –≤—ã–µ–º–∫–∏
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –≤—ã–µ–º–∫–∏/–∫–æ–Ω–≤–µ—Ä—Ç–∞

**–ü–æ–ª—å–∑–∞:**
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ UI (instant –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
- –≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞

---

#### 3. Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (WebSocket)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ö–æ–≥–¥–∞ –æ–¥–∏–Ω –∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç –≤—ã–µ–º–∫—É, –¥—Ä—É–≥–æ–π –∞–¥–º–∏–Ω –Ω–µ –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –¥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å WebSocket –¥–ª—è push-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:
```javascript
// –°–µ—Ä–≤–µ—Ä: loyalty-proxy/websocket_server.js
io.on('connection', (socket) => {
  socket.on('subscribe:main_cash', () => {
    socket.join('main_cash_updates');
  });
});

// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã–µ–º–∫–∏/–∫–æ–Ω–≤–µ—Ä—Ç–∞
io.to('main_cash_updates').emit('balance_updated', {
  shopAddress: '—É–ª. –õ–µ–Ω–∏–Ω–∞, 1',
  newBalance: 68000.0
});
```

```dart
// –ö–ª–∏–µ–Ω—Ç: lib/core/services/websocket_service.dart
class WebSocketService {
  static void subscribeToMainCashUpdates(Function(Map) callback) {
    _socket.on('balance_updated', callback);
  }
}

// –í MainCashPage
WebSocketService.subscribeToMainCashUpdates((data) {
  setState(() {
    _updateBalanceForShop(data['shopAddress'], data['newBalance']);
  });
});
```

**–ü–æ–ª—å–∑–∞:**
- Instant —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –∞–¥–º–∏–Ω–∞–º–∏
- –£–ª—É—á—à–µ–Ω–∏–µ UX
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ (–Ω–µ –Ω—É–∂–Ω–æ –ø–æ–ª–ª–∏–Ω–≥)

---

### 8.2 üü° –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 1. –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:**
–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–∂–∏–¥–∞–µ–º—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ pending –æ—Ç—á—ë—Ç–æ–≤:
```dart
class ShopCashBalance {
  final double currentBalance;
  final double pendingBalance;    // –ë–∞–ª–∞–Ω—Å —Å —É—á—ë—Ç–æ–º pending –æ—Ç—á—ë—Ç–æ–≤

  double get projectedBalance => currentBalance + pendingBalance;
}
```

**UI:**
```
–ú–∞–≥–∞–∑–∏–Ω: —É–ª. –õ–µ–Ω–∏–Ω–∞, 1
–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 45000 —Ä—É–±
–û–∂–∏–¥–∞–µ—Ç—Å—è: +8000 —Ä—É–± (–∏–∑ pending –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤)
–ü—Ä–æ–≥–Ω–æ–∑: 53000 —Ä—É–±
```

**–ü–æ–ª—å–∑–∞:**
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Å—Ä–µ–¥—Å—Ç–≤

---

#### 2. –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞

**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:**
–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º:
```dart
class BalanceChange {
  final String shopAddress;
  final String type;              // 'envelope' –∏–ª–∏ 'withdrawal'
  final double amount;            // –°—É–º–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è (+/-)
  final double balanceBefore;
  final double balanceAfter;
  final DateTime timestamp;
  final String performedBy;       // –ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞/–∞–¥–º–∏–Ω–∞
  final String? reason;           // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
}
```

**UI:**
–ö–Ω–æ–ø–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π" –≤ `ShopBalanceDetailsPage`:
```
26.01.2026 14:00 | –í—ã–µ–º–∫–∞ | -75000 —Ä—É–± | –ú–∞—Ä–∏—è
26.01.2026 12:00 | –ö–æ–Ω–≤–µ—Ä—Ç | +8000 —Ä—É–± | –ê–ª–µ–∫—Å–µ–π
25.01.2026 20:00 | –ö–æ–Ω–≤–µ—Ä—Ç | +15000 —Ä—É–± | –î–º–∏—Ç—Ä–∏–π
```

**–ü–æ–ª—å–∑–∞:**
- Audit trail –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ–∏—Å–∫ –ø—Ä–∏—á–∏–Ω —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π
- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π

---

#### 3. –û—Ç—á—ë—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

**–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:**
–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≥–ª–∞–≤–Ω–æ–π –∫–∞—Å—Å—ã:

```dart
// lib/features/main_cash/pages/main_cash_analytics_page.dart

–ì—Ä–∞—Ñ–∏–∫–∏:
  ‚îú‚îÄ –î–∏–Ω–∞–º–∏–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–æ –¥–Ω—è–º (–ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫)
  ‚îú‚îÄ –î–æ—Ö–æ–¥ vs –†–∞—Å—Ö–æ–¥ –ø–æ –º–µ—Å—è—Ü–∞–º (—Å—Ç–æ–ª–±—á–∞—Ç—ã–π –≥—Ä–∞—Ñ–∏–∫)
  ‚îú‚îÄ –¢–æ–ø –º–∞–≥–∞–∑–∏–Ω–æ–≤ –ø–æ –æ–±–æ—Ä–æ—Ç—É (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞)
  ‚îî‚îÄ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)

–§–∏–ª—å—Ç—Ä—ã:
  ‚îú‚îÄ –í—ã–±–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ (–≤—Å–µ / –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π)
  ‚îú‚îÄ –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ (–Ω–µ–¥–µ–ª—è / –º–µ—Å—è—Ü / –∫–≤–∞—Ä—Ç–∞–ª / –≥–æ–¥)
  ‚îî‚îÄ –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö (–û–û–û / –ò–ü / –≤—Å—ë)
```

**–ü–æ–ª—å–∑–∞:**
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –í—ã—è–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤
- –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö

---

### 8.3 üü¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 1. –ü–∞–≥–∏–Ω–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤/–∫–æ–Ω–≤–µ—Ä—Ç–æ–≤/–≤—ã–µ–º–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é:
```dart
static Future<PaginatedResult<EnvelopeReport>> getReports({
  int page = 1,
  int limit = 20,
  String? shopAddress,
  String? status,
}) async {
  final result = await BaseHttpService.getList<EnvelopeReport>(
    endpoint: '$baseEndpoint?page=$page&limit=$limit&shopAddress=$shopAddress&status=$status',
    fromJson: (json) => EnvelopeReport.fromJson(json),
    listKey: 'reports',
  );

  return PaginatedResult(
    items: result.items,
    total: result.total,
    page: page,
    limit: limit,
  );
}
```

**UI:**
–î–æ–±–∞–≤–∏—Ç—å "Load More" –∫–Ω–æ–ø–∫—É –∏–ª–∏ infinite scroll.

**–ü–æ–ª—å–∑–∞:**
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü
- –°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
- –£–ª—É—á—à–µ–Ω–∏–µ UX

---

#### 2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ö–ª–∏–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:**
–£–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –¥–ª—è –≤—ã–µ–º–æ–∫ (`WithdrawalService` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã).
–†–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤:
```javascript
// loyalty-proxy/index.js
app.get('/api/envelope-reports', (req, res) => {
  const { shopAddress, status, fromDate, toDate, page = 1, limit = 20 } = req.query;

  let reports = loadAllReports();

  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
  if (shopAddress) {
    reports = reports.filter(r => r.shopAddress === shopAddress);
  }
  if (status) {
    reports = reports.filter(r => r.status === status);
  }
  if (fromDate) {
    reports = reports.filter(r => new Date(r.createdAt) >= new Date(fromDate));
  }
  if (toDate) {
    reports = reports.filter(r => new Date(r.createdAt) <= new Date(toDate));
  }

  // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
  const start = (page - 1) * limit;
  const end = start + limit;
  const paginatedReports = reports.slice(start, end);

  res.json({
    success: true,
    reports: paginatedReports,
    total: reports.length,
    page,
    limit
  });
});
```

**–ü–æ–ª—å–∑–∞:**
- –°–Ω–∏–∂–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

---

#### 3. –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ñ–∞–π–ª–æ–≤ JSON –ø–æ–∏—Å–∫ –ø–æ `shopAddress`, `type`, `date` –º–µ–¥–ª–µ–Ω–Ω—ã–π.

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```javascript
// loyalty-proxy/utils/file_indexer.js
class FileIndexer {
  constructor(directory) {
    this.directory = directory;
    this.index = {
      byShopAddress: new Map(),
      byDate: new Map(),
      byType: new Map(),
    };
    this.buildIndex();
  }

  buildIndex() {
    const files = fs.readdirSync(this.directory);
    for (const file of files) {
      const data = JSON.parse(fs.readFileSync(path.join(this.directory, file), 'utf8'));

      // –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ shopAddress
      if (!this.index.byShopAddress.has(data.shopAddress)) {
        this.index.byShopAddress.set(data.shopAddress, []);
      }
      this.index.byShopAddress.get(data.shopAddress).push(file);

      // –¢–æ –∂–µ –¥–ª—è date –∏ type
    }
  }

  findByShopAddress(shopAddress) {
    return this.index.byShopAddress.get(shopAddress) || [];
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const withdrawalsIndex = new FileIndexer('/var/www/withdrawals/');
const files = withdrawalsIndex.findByShopAddress('—É–ª. –õ–µ–Ω–∏–Ω–∞, 1');
```

**–ü–æ–ª—å–∑–∞:**
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –≤ 10-100 —Ä–∞–∑
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –¥–∏—Å–∫
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

---

### 8.4 üî¥ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:**
–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```javascript
// POST /api/withdrawals
const { expenses, totalAmount } = req.body;

// –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: totalAmount = sum(expenses.amount)
const calculatedTotal = expenses.reduce((sum, e) => sum + e.amount, 0);
if (Math.abs(calculatedTotal - totalAmount) > 0.01) {
  return res.status(400).json({
    success: false,
    error: 'Total amount mismatch'
  });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: amount >= 0
if (expenses.some(e => e.amount < 0)) {
  return res.status(400).json({
    success: false,
    error: 'Negative amounts not allowed'
  });
}
```

–î–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤:
```javascript
// POST /api/envelope-reports
const { oooCash, oooTotalExpenses, ipCash, totalExpenses } = req.body;

// –ü—Ä–æ–≤–µ—Ä–∫–∞: oooCash >= oooTotalExpenses
if (oooCash < oooTotalExpenses) {
  return res.status(400).json({
    success: false,
    error: '–û–û–û cash cannot be less than expenses'
  });
}

// –¢–æ –∂–µ –¥–ª—è –ò–ü
if (ipCash < totalExpenses) {
  return res.status(400).json({
    success: false,
    error: '–ò–ü cash cannot be less than expenses'
  });
}
```

**–ü–æ–ª—å–∑–∞:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤–≤–æ–¥–∞
- –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –ó–∞—â–∏—Ç–∞ –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞

---

#### 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (atomicity)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–µ–º–∫–∏ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –≤—ã–µ–º–∫–∏
2. –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –∫–∞—Å—Å—ã
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

–ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è 2 –∏–ª–∏ 3 fails, —Å–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ inconsistent state.

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
```javascript
// withdrawals_api.js
const createWithdrawal = async (req, res) => {
  const transaction = new Transaction();

  try {
    // 1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª
    transaction.addStep(() => {
      fs.writeFileSync(filePath, JSON.stringify(withdrawal), 'utf8');
    }, () => {
      fs.unlinkSync(filePath);  // Rollback
    });

    // 2. –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
    transaction.addStep(() => {
      updateMainCashBalance(shopAddress, type, totalAmount);
    }, () => {
      updateMainCashBalance(shopAddress, type, -totalAmount);  // Rollback
    });

    // 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å push
    transaction.addStep(() => {
      return sendWithdrawalNotifications(withdrawal);
    }, () => {
      // Push rollback –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω, –Ω–æ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–º–µ–Ω—É
    });

    await transaction.execute();
    res.json({ success: true, withdrawal });

  } catch (error) {
    await transaction.rollback();
    res.status(500).json({ success: false, error: error.message });
  }
};
```

**–ü–æ–ª—å–∑–∞:**
- Atomicity –æ–ø–µ—Ä–∞—Ü–∏–π
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã

---

#### 3. –û—Ç–∫–∞—Ç–∞ (undo)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ï—Å–ª–∏ –∞–¥–º–∏–Ω –æ—à–∏–±–æ—á–Ω–æ —Å–æ–∑–¥–∞–ª –≤—ã–µ–º–∫—É, –µ—ë –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–∏—Ç—å, –Ω–æ –±–∞–ª–∞–Ω—Å —É–∂–µ –∏–∑–º–µ–Ω–∏–ª—Å—è.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–∫–∞—Ç–∞:
```dart
// withdrawal_service.dart
static Future<bool> undoWithdrawal(String id) async {
  return await BaseHttpService.post(
    endpoint: '$baseEndpoint/$id/undo',
    body: {},
  );
}
```

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```javascript
// POST /api/withdrawals/:id/undo
app.post('/api/withdrawals/:id/undo', (req, res) => {
  const withdrawal = loadWithdrawal(req.params.id);

  // 1. –û—Ç–∫–∞—Ç–∏—Ç—å –±–∞–ª–∞–Ω—Å
  updateMainCashBalance(
    withdrawal.shopAddress,
    withdrawal.type,
    -withdrawal.totalAmount  // –û–±—Ä–∞—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
  );

  // 2. –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ undone
  withdrawal.status = 'undone';
  withdrawal.undoneAt = new Date().toISOString();
  withdrawal.undoneBy = req.body.adminName;
  saveWithdrawal(withdrawal);

  // 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  sendUndoNotification(withdrawal);

  res.json({ success: true });
});
```

**UI:**
–ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å" —Ä—è–¥–æ–º —Å –≤—ã–µ–º–∫–æ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–¥–∞–≤–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–∞–ø—Ä–∏–º–µ—Ä, < 1 —á–∞—Å–∞).

**–ü–æ–ª—å–∑–∞:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
- –£–ª—É—á—à–µ–Ω–∏–µ UX
- Audit trail (–∏—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ–Ω)

---

## 9. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

### 9.1 –•—Ä–∞–Ω–∏–ª–∏—â–µ

| –°—É—â–Ω–æ—Å—Ç—å | –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è | –§–æ—Ä–º–∞—Ç | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------|-----------|--------|-----------|
| Withdrawals | `/var/www/withdrawals/` | JSON —Ñ–∞–π–ª—ã | –û–¥–∏–Ω —Ñ–∞–π–ª –Ω–∞ –≤—ã–µ–º–∫—É |
| EnvelopeReports | `/var/www/envelope-reports/` | JSON —Ñ–∞–π–ª—ã | –û–¥–∏–Ω —Ñ–∞–π–ª –Ω–∞ –æ—Ç—á–µ—Ç |
| EnvelopeQuestions | `/var/www/envelope-questions/` | JSON —Ñ–∞–π–ª—ã | –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ |
| MainCashBalance | `/var/www/main_cash/` | JSON —Ñ–∞–π–ª—ã | –ö–µ—à –±–∞–ª–∞–Ω—Å–∞ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ –≤—ã–µ–º–∫–∏:**
```
/var/www/withdrawals/withdrawal_1769420000000_abc123.json
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞:**
```
/var/www/envelope-reports/envelope_1769420000000_xyz789.json
```

---

### 9.2 Rate Limiting

```javascript
// loyalty-proxy/index.js
const withdrawalsRateLimiter = rateLimit({
  windowMs: 60 * 1000,     // 1 –º–∏–Ω—É—Ç–∞
  max: 10,                 // –ú–∞–∫—Å–∏–º—É–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤
  message: 'Too many withdrawal requests',
  standardHeaders: true,
  legacyHeaders: false,
});

app.use('/api/withdrawals', withdrawalsRateLimiter);

// –û–±—â–∏–π rate limiter
const generalRateLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 500,
  message: 'Too many requests',
});

app.use('/api/*', generalRateLimiter);
```

**–ü–æ—á–µ–º—É stricter limiter –¥–ª—è withdrawals:**
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç –∑–∞—â–∏—Ç—ã
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ abuse
- –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS

---

### 9.3 –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**CORS:**
```javascript
const cors = require('cors');
app.use(cors({
  origin: [
    'http://localhost:3000',
    'https://arabica26.ru'
  ],
  credentials: true
}));
```

**Trust Proxy:**
```javascript
app.set('trust proxy', 1);  // –î–ª—è —Ä–∞–±–æ—Ç—ã –∑–∞ nginx
```

**–ó–∞—â–∏—Ç–∞ —Ñ–∞–π–ª–æ–≤:**
- –í—Å–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ `/var/www/` (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞–ø—Ä—è–º—É—é)
- –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ API endpoints
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

---

### 9.4 Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã–µ–º–∫–∏:**
```javascript
await sendWithdrawalNotifications({
  title: '–ù–æ–≤–∞—è –≤—ã–µ–º–∫–∞',
  body: `–ú–∞–≥–∞–∑–∏–Ω: ${shopAddress}\n–°—É–º–º–∞: ${totalAmount} —Ä—É–±`,
  data: {
    type: 'withdrawal',
    id: withdrawal.id,
    shopAddress: withdrawal.shopAddress
  }
});
```

**–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:**
- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ä–æ–ª—å—é `admin`

---

## 10. –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-------------|
| **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** | 9/10 | –ú–æ–¥—É–ª—å–Ω–∞—è, —á—ë—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ |
| **–ö–æ–¥ –∫–∞—á–µ—Å—Ç–≤–æ** | 8/10 | –ß–∏—Å—Ç—ã–π –∫–æ–¥, –Ω–æ –µ—Å—Ç—å –º–µ—Å—Ç–∞ –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ |
| **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** | 10/10 | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** | 10/10 | ‚úÖ –û—Ç–ª–∏—á–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | 7/10 | –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å (–ø–∞–≥–∏–Ω–∞—Ü–∏—è, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ) |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | 7/10 | –ï—Å—Ç—å rate limiting, –Ω–æ –Ω—É–∂–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö |
| **UX/UI** | 9/10 | –ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —Ö–æ—Ä–æ—à–æ –ø—Ä–æ–¥—É–º–∞–Ω |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** ‚úÖ **8.7/10** - –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ —Ö–æ—Ä–æ—à–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞. –ï—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏.

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú–æ–¥—É–ª–∏ "–ì–ª–∞–≤–Ω–∞—è –ö–∞—Å—Å–∞" –∏ "–ö–æ–Ω–≤–µ—Ä—Ç" —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ **—Å–∏–Ω–µ—Ä–≥–∏—á–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞** —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã Arabica:

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:

1. **–ö–æ–Ω–≤–µ—Ä—Ç** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è **—Å–±–æ—Ä–∞ –¥–æ—Ö–æ–¥–æ–≤** –æ—Ç –º–∞–≥–∞–∑–∏–Ω–æ–≤
2. **–ì–ª–∞–≤–Ω–∞—è –ö–∞—Å—Å–∞** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π **–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–º**
3. **–í—ã–µ–º–∫–∏** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ **—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤**
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –±–µ–∑—É–ø—Ä–µ—á–Ω–∞—è —Å–≤—è–∑—å –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏ —á–µ—Ä–µ–∑ –æ–±—â–∏–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
5. **UI/UX** - –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤

### üìä –ö–ª—é—á–µ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Å–∏—Å—Ç–µ–º—ã:

```
–ë–∞–ª–∞–Ω—Å –º–∞–≥–∞–∑–∏–Ω–∞ = –î–æ—Ö–æ–¥ (–∏–∑ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤) - –†–∞—Å—Ö–æ–¥ (–∏–∑ –≤—ã–µ–º–æ–∫)

–ì–¥–µ:
  –î–æ—Ö–æ–¥ = sum(EnvelopeReport.oooCash + EnvelopeReport.ipCash)
  –†–∞—Å—Ö–æ–¥ = sum(Withdrawal.totalAmount)
```

### üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

1. **üî¥ –í—ã—Å–æ–∫–∏–π:** –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤–≤–æ–¥–∞)
2. **üî¥ –í—ã—Å–æ–∫–∏–π:** –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (atomicity –æ–ø–µ—Ä–∞—Ü–∏–π)
3. **üü° –°—Ä–µ–¥–Ω–∏–π:** –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (–Ω–∞ –æ—Å–Ω–æ–≤–µ pending –æ—Ç—á—ë—Ç–æ–≤)
4. **üü° –°—Ä–µ–¥–Ω–∏–π:** –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (audit trail)
5. **üü¢ –ù–∏–∑–∫–∏–π:** –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)

### üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–≥—Ä–∞—Ñ–∏–∫–∏, –æ—Ç—á—ë—Ç—ã)
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø–∞–≥–∏–Ω–∞—Ü–∏—è, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
5. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–∫–∞—Ç–∞ –¥–ª—è –æ—à–∏–±–æ—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–°—Ç–∞—Ç—É—Å:** –ú–æ–¥—É–ª–∏ –≥–æ—Ç–æ–≤—ã –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –≤ –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã.

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞:** 2026-01-26
**–ê–≤—Ç–æ—Ä:** Claude Code Analysis
**–í–µ—Ä—Å–∏—è:** 1.0
