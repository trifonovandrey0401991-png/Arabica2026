<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1100">
  <defs>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
    <linearGradient id="userGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#4CAF50"/>
      <stop offset="100%" style="stop-color:#2E7D32"/>
    </linearGradient>
    <linearGradient id="adminGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#F44336"/>
      <stop offset="100%" style="stop-color:#C62828"/>
    </linearGradient>
    <linearGradient id="employeeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#2196F3"/>
      <stop offset="100%" style="stop-color:#1565C0"/>
    </linearGradient>
    <linearGradient id="clientGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#FF9800"/>
      <stop offset="100%" style="stop-color:#EF6C00"/>
    </linearGradient>
    <linearGradient id="serverGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#9C27B0"/>
      <stop offset="100%" style="stop-color:#6A1B9A"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="1400" height="1100" fill="#f5f5f5"/>

  <!-- Title -->
  <text x="700" y="40" text-anchor="middle" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="#333">
    СИСТЕМА РЕГИСТРАЦИИ / АВТОРИЗАЦИИ
  </text>
  <text x="700" y="65" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#666">
    Arabica App - Блок A, Система #1
  </text>

  <!-- ============ VISUAL FLOW SECTION ============ -->
  <rect x="20" y="85" width="860" height="500" rx="10" fill="white" stroke="#ddd" filter="url(#shadow)"/>
  <text x="450" y="110" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#333">
    ВИЗУАЛЬНАЯ СХЕМА АВТОРИЗАЦИИ
  </text>

  <!-- User Input Block -->
  <rect x="50" y="140" width="180" height="80" rx="10" fill="url(#userGrad)" filter="url(#shadow)"/>
  <text x="140" y="175" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="white">ПОЛЬЗОВАТЕЛЬ</text>
  <text x="140" y="195" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="white">Вводит телефон</text>

  <!-- Arrow 1 -->
  <path d="M230 180 L280 180" stroke="#333" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
  </defs>

  <!-- Check Existing Block -->
  <rect x="290" y="140" width="180" height="80" rx="10" fill="#607D8B" filter="url(#shadow)"/>
  <text x="380" y="170" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">ПРОВЕРКА</text>
  <text x="380" y="188" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">LoyaltyService</text>
  <text x="380" y="203" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">.fetchByPhone()</text>

  <!-- Decision Diamond -->
  <polygon points="560,180 620,140 680,180 620,220" fill="#FFC107" stroke="#F57F17" stroke-width="2"/>
  <text x="620" y="175" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#333">Найден?</text>
  <text x="620" y="190" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">в базе</text>

  <!-- Arrow to diamond -->
  <path d="M470 180 L555 180" stroke="#333" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

  <!-- NO branch - New User Registration -->
  <path d="M620 220 L620 270" stroke="#E53935" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="640" y="250" font-family="Arial, sans-serif" font-size="10" fill="#E53935">НЕТ</text>

  <rect x="530" y="280" width="180" height="70" rx="10" fill="#FF7043" filter="url(#shadow)"/>
  <text x="620" y="305" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">РЕГИСТРАЦИЯ</text>
  <text x="620" y="322" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">Ввод имени +</text>
  <text x="620" y="337" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">Реферальный код</text>

  <!-- YES branch -->
  <path d="M680 180 L740 180" stroke="#4CAF50" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="700" y="170" font-family="Arial, sans-serif" font-size="10" fill="#4CAF50">ДА</text>

  <!-- Role Check Block -->
  <rect x="750" y="140" width="120" height="80" rx="10" fill="url(#serverGrad)" filter="url(#shadow)"/>
  <text x="810" y="170" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">ОПРЕДЕЛЕНИЕ</text>
  <text x="810" y="188" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">РОЛИ</text>
  <text x="810" y="203" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">getUserRole()</text>

  <!-- Connect registration to role check -->
  <path d="M710 315 L810 315 L810 225" stroke="#333" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

  <!-- Three Role Branches -->
  <!-- Admin -->
  <path d="M810 220 L810 280 L690 280 L690 390" stroke="#F44336" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <rect x="600" y="400" width="180" height="70" rx="10" fill="url(#adminGrad)" filter="url(#shadow)"/>
  <text x="690" y="430" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="white">АДМИН</text>
  <text x="690" y="450" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">AdminHomePage</text>

  <!-- Employee -->
  <path d="M810 220 L810 390" stroke="#2196F3" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <rect x="720" y="400" width="180" height="70" rx="10" fill="url(#employeeGrad)" filter="url(#shadow)"/>
  <text x="810" y="430" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="white">СОТРУДНИК</text>
  <text x="810" y="450" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">EmployeePanelPage</text>

  <!-- Client -->
  <path d="M810 220 L810 280 L930 280 L930 390" stroke="#FF9800" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <rect x="840" y="400" width="180" height="70" rx="10" fill="url(#clientGrad)" filter="url(#shadow)"/>
  <text x="930" y="430" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="white">КЛИЕНТ</text>
  <text x="930" y="450" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">ClientHomePage</text>

  <!-- Role determination logic box -->
  <rect x="50" y="260" width="450" height="220" rx="8" fill="#E3F2FD" stroke="#1976D2" stroke-width="1"/>
  <text x="275" y="285" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#1565C0">
    ЛОГИКА ОПРЕДЕЛЕНИЯ РОЛИ
  </text>

  <text x="70" y="315" font-family="Arial, sans-serif" font-size="12" fill="#333">1. Проверка в списке админов (_adminPhones)</text>
  <text x="90" y="335" font-family="Arial, sans-serif" font-size="11" fill="#666">→ Если найден → роль = admin</text>

  <text x="70" y="365" font-family="Arial, sans-serif" font-size="12" fill="#333">2. Проверка в /api/employees</text>
  <text x="90" y="385" font-family="Arial, sans-serif" font-size="11" fill="#666">→ Если найден И isVerified=true → роль = employee</text>

  <text x="70" y="415" font-family="Arial, sans-serif" font-size="12" fill="#333">3. Иначе</text>
  <text x="90" y="435" font-family="Arial, sans-serif" font-size="11" fill="#666">→ роль = client</text>

  <text x="70" y="465" font-family="Arial, sans-serif" font-size="11" fill="#1976D2" font-style="italic">
    * Админ-телефоны захардкожены в UserRoleService
  </text>

  <!-- FCM Token Block -->
  <rect x="50" y="495" width="200" height="70" rx="8" fill="#E8F5E9" stroke="#4CAF50" stroke-width="1"/>
  <text x="150" y="520" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#2E7D32">FCM ТОКЕН</text>
  <text x="150" y="540" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">Сохраняется после входа</text>
  <text x="150" y="555" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#333">POST /api/fcm/token</text>

  <!-- ============ DESCRIPTION SECTION ============ -->
  <rect x="900" y="85" width="480" height="500" rx="10" fill="white" stroke="#ddd" filter="url(#shadow)"/>
  <text x="1140" y="110" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#333">
    ОПИСАНИЕ СИСТЕМЫ
  </text>

  <!-- Files Section -->
  <rect x="920" y="125" width="440" height="140" rx="5" fill="#FFF3E0" stroke="#FF9800"/>
  <text x="1140" y="145" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#E65100">ФАЙЛЫ FLUTTER</text>

  <text x="940" y="170" font-family="monospace" font-size="10" fill="#333">lib/features/clients/pages/</text>
  <text x="955" y="185" font-family="monospace" font-size="10" fill="#1565C0">registration_page.dart</text>
  <text x="1160" y="185" font-family="Arial" font-size="9" fill="#666">← UI страница входа</text>

  <text x="940" y="205" font-family="monospace" font-size="10" fill="#333">lib/features/employees/services/</text>
  <text x="955" y="220" font-family="monospace" font-size="10" fill="#1565C0">user_role_service.dart</text>
  <text x="1160" y="220" font-family="Arial" font-size="9" fill="#666">← Логика ролей</text>

  <text x="940" y="240" font-family="monospace" font-size="10" fill="#333">lib/features/employees/models/</text>
  <text x="955" y="255" font-family="monospace" font-size="10" fill="#1565C0">user_role_model.dart</text>
  <text x="1160" y="255" font-family="Arial" font-size="9" fill="#666">← Enum ролей</text>

  <!-- API Section -->
  <rect x="920" y="275" width="440" height="115" rx="5" fill="#E8F5E9" stroke="#4CAF50"/>
  <text x="1140" y="295" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#2E7D32">API ЭНДПОИНТЫ</text>

  <text x="940" y="320" font-family="monospace" font-size="10" fill="#333">GET  /api/employees</text>
  <text x="1160" y="320" font-family="Arial" font-size="9" fill="#666">← Список сотрудников</text>

  <text x="940" y="340" font-family="monospace" font-size="10" fill="#333">GET  /api/clients/:phone</text>
  <text x="1160" y="340" font-family="Arial" font-size="9" fill="#666">← Проверка клиента</text>

  <text x="940" y="360" font-family="monospace" font-size="10" fill="#333">POST /api/clients</text>
  <text x="1160" y="360" font-family="Arial" font-size="9" fill="#666">← Создание клиента</text>

  <text x="940" y="380" font-family="monospace" font-size="10" fill="#333">POST /api/fcm/token</text>
  <text x="1160" y="380" font-family="Arial" font-size="9" fill="#666">← Сохранение FCM</text>

  <!-- Storage Section -->
  <rect x="920" y="400" width="440" height="85" rx="5" fill="#E3F2FD" stroke="#2196F3"/>
  <text x="1140" y="420" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#1565C0">ХРАНЕНИЕ ДАННЫХ</text>

  <text x="940" y="445" font-family="Arial" font-size="11" fill="#333" font-weight="bold">SharedPreferences (локально):</text>
  <text x="955" y="462" font-family="monospace" font-size="10" fill="#666">userPhone, userName, userRole, user_verified</text>

  <text x="940" y="478" font-family="Arial" font-size="11" fill="#333" font-weight="bold">Сервер:</text>
  <text x="1005" y="478" font-family="monospace" font-size="10" fill="#666">/data/employees.json, /data/clients.json</text>

  <!-- Roles Legend -->
  <rect x="920" y="495" width="440" height="80" rx="5" fill="#F3E5F5" stroke="#9C27B0"/>
  <text x="1140" y="515" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#7B1FA2">РОЛИ ПОЛЬЗОВАТЕЛЕЙ</text>

  <rect x="940" y="530" width="15" height="15" fill="url(#adminGrad)" rx="3"/>
  <text x="965" y="543" font-family="Arial" font-size="11" fill="#333">admin - Полный доступ</text>

  <rect x="1090" y="530" width="15" height="15" fill="url(#employeeGrad)" rx="3"/>
  <text x="1115" y="543" font-family="Arial" font-size="11" fill="#333">employee - Панель работника</text>

  <rect x="1010" y="555" width="15" height="15" fill="url(#clientGrad)" rx="3"/>
  <text x="1035" y="568" font-family="Arial" font-size="11" fill="#333">client - Меню и заказы</text>

  <!-- ============ SERVER SECTION ============ -->
  <rect x="20" y="600" width="1360" height="200" rx="10" fill="white" stroke="#ddd" filter="url(#shadow)"/>
  <text x="700" y="625" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#333">
    СЕРВЕРНАЯ ЧАСТЬ (loyalty-proxy/index.js)
  </text>

  <!-- Server endpoints detail -->
  <rect x="40" y="640" width="320" height="145" rx="5" fill="#FAFAFA" stroke="#9E9E9E"/>
  <text x="200" y="660" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#333">GET /api/employees</text>
  <text x="60" y="685" font-family="Arial" font-size="10" fill="#666">Возвращает массив сотрудников:</text>
  <text x="60" y="705" font-family="monospace" font-size="9" fill="#333">[{</text>
  <text x="75" y="720" font-family="monospace" font-size="9" fill="#333">"phone": "79181234567",</text>
  <text x="75" y="735" font-family="monospace" font-size="9" fill="#333">"name": "Иван Иванов",</text>
  <text x="75" y="750" font-family="monospace" font-size="9" fill="#333">"isVerified": true,</text>
  <text x="75" y="765" font-family="monospace" font-size="9" fill="#333">"shopAddress": "ул. Ленина 1"</text>
  <text x="60" y="780" font-family="monospace" font-size="9" fill="#333">}, ...]</text>

  <rect x="380" y="640" width="320" height="145" rx="5" fill="#FAFAFA" stroke="#9E9E9E"/>
  <text x="540" y="660" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#333">GET /api/clients/:phone</text>
  <text x="400" y="685" font-family="Arial" font-size="10" fill="#666">Поиск клиента по телефону:</text>
  <text x="400" y="705" font-family="monospace" font-size="9" fill="#333">{</text>
  <text x="415" y="720" font-family="monospace" font-size="9" fill="#333">"phone": "79181234567",</text>
  <text x="415" y="735" font-family="monospace" font-size="9" fill="#333">"name": "Клиент",</text>
  <text x="415" y="750" font-family="monospace" font-size="9" fill="#333">"bonuses": 150,</text>
  <text x="415" y="765" font-family="monospace" font-size="9" fill="#333">"referralCode": "ABC123"</text>
  <text x="400" y="780" font-family="monospace" font-size="9" fill="#333">}</text>

  <rect x="720" y="640" width="320" height="145" rx="5" fill="#FAFAFA" stroke="#9E9E9E"/>
  <text x="880" y="660" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#333">POST /api/fcm/token</text>
  <text x="740" y="685" font-family="Arial" font-size="10" fill="#666">Сохранение токена для push:</text>
  <text x="740" y="705" font-family="monospace" font-size="9" fill="#333">Request body:</text>
  <text x="740" y="725" font-family="monospace" font-size="9" fill="#333">{</text>
  <text x="755" y="740" font-family="monospace" font-size="9" fill="#333">"phone": "79181234567",</text>
  <text x="755" y="755" font-family="monospace" font-size="9" fill="#333">"token": "fcm_token_here",</text>
  <text x="755" y="770" font-family="monospace" font-size="9" fill="#333">"role": "employee"</text>
  <text x="740" y="785" font-family="monospace" font-size="9" fill="#333">}</text>

  <rect x="1060" y="640" width="300" height="145" rx="5" fill="#FFEBEE" stroke="#E53935"/>
  <text x="1210" y="660" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#C62828">ФАЙЛЫ ДАННЫХ</text>
  <text x="1080" y="685" font-family="monospace" font-size="10" fill="#333">/root/arabica_app/data/</text>
  <text x="1095" y="710" font-family="monospace" font-size="10" fill="#1565C0">employees.json</text>
  <text x="1230" y="710" font-family="Arial" font-size="9" fill="#666">← Сотрудники</text>
  <text x="1095" y="730" font-family="monospace" font-size="10" fill="#1565C0">clients.json</text>
  <text x="1230" y="730" font-family="Arial" font-size="9" fill="#666">← Клиенты</text>
  <text x="1095" y="750" font-family="monospace" font-size="10" fill="#1565C0">fcm_tokens.json</text>
  <text x="1230" y="750" font-family="Arial" font-size="9" fill="#666">← FCM токены</text>

  <!-- ============ NOTES SECTION ============ -->
  <rect x="20" y="815" width="1360" height="100" rx="10" fill="#FFFDE7" stroke="#FBC02D" filter="url(#shadow)"/>
  <text x="700" y="840" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#F57F17">
    ВАЖНЫЕ ЗАМЕЧАНИЯ
  </text>
  <text x="40" y="865" font-family="Arial" font-size="12" fill="#333">
    1. Админ-телефоны захардкожены в коде (UserRoleService._adminPhones) - требует пересборки приложения для изменения
  </text>
  <text x="40" y="885" font-family="Arial" font-size="12" fill="#333">
    2. Сотрудник должен быть isVerified=true для получения роли employee, иначе будет client
  </text>
  <text x="40" y="905" font-family="Arial" font-size="12" fill="#333">
    3. FCM токен сохраняется для push-уведомлений о заказах (для сотрудников) и акциях (для клиентов)
  </text>

  <!-- Version info -->
  <rect x="20" y="930" width="1360" height="50" rx="10" fill="#E0E0E0"/>
  <text x="700" y="960" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#666">
    Arabica App v1.6.1 | Документация: Блок A - Система #1 | Создано: 2026-01-13
  </text>
</svg>
